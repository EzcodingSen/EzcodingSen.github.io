---
title: 'CTC decoder in PaddleOCR'
date: 2024-12-04
permalink: /notebook/2024/12/CTC decoder in PaddleOCR/
tags:
  - OCR
---

CTC decoder in PaddleOCR

CTC 解码器的理论：
======

CTC（Connectionist Temporal Classification）解码器是一种专为处理输入长度和输出序列长度不一致的序列建模问题而设计的算法。它特别适用于语音识别、文本识别（如OCR）等领域。他的基本思想是从一个输入序列 
𝑋中预测一个对齐的输出序列𝑌，同时**避免显式地对每个输入和输出时间步进行对齐**。  
怎么理解这个显式的对齐呢？举个例子：输入是一段语音，输出是文字。显示的对齐则需要手动标记每个语音帧的输出字符。显然这是非常繁琐昂贵的。为此，CTC引入了一个特殊的 "blank" 标签（通常记为 "−" 或 "𝜖"），用于表示**无输出或忽略**的时间步，从而允许输出序列的长度小于输入序列。 

CTC的核心步骤
------

### 1.对齐路径（Alignment Paths）  
CTC定义了所有可能的对齐路径，用来从输入序列生成目标输出序列。这些路径包括目标序列插入 "blank" 标签后的所有可能时间步扩展。例如：  
输入序列长度：5  
输出序列：𝐴𝐵  
可能的路径是：A - - B / A - B - / - A B -等。  
### 2.路径概率计算  
给定模型输出的每个时间步上的概率分布𝑃(𝑐<sub>𝑡</sub>∣𝑡)（即预测某字符𝑐<sub>𝑡</sub>在时间𝑡的概率），CTC将每个𝑃(𝑐<sub>𝑡</sub>∣𝑡)乘起来，得到每条路径的概率:  

$$
P(\pi \mid X) = \prod_{t=1}^{T} P(c_t \mid t),
$$

其中𝜋表示一条路径。同样的，以上面可能的路径A - - B为例： 

$$
P(\pi \mid X) = P(A \mid t=1)⋅P(- \mid t=2)⋅P(- \mid t=3)⋅P(B \mid t=4)
$$    
   
**PS**：CTC时间步在常见OCR模型中的含义：  
如果在 OCR 模型中使用 CTC 解码，而模型的结构并非 RNN，而是基于 CNN 等“平行时间步”的结构（如 CRNN 中的卷积部分或完全基于 CNN 的模型），时间步实际上指的是特征图的宽度维度上每个位置的输出。在backbone中经过CNN提取特征后：输出一个特征图，大小可能是 𝐶×𝐻′×𝑊′，其中𝑊′对应于“时间步”，而每个时间步表示特征图**宽度维度**上的某个位置，它对应输入图像中的某一列区域。
    
看到这里，你可能会疑惑：既然能得到每个时间步上预测字符的概率分布，那么直接取每个时间步上概率最大的那个字符组成目标序列就可以了，哪里来的多条路径呢？   
实际上，CTC的核心思想正是**允许多条路径对同一个目标序列的贡献**，来实现对目标序列概率的全面建模。如果采用**贪心解码**，即在每个时间步𝑡上采用概率最大的字符，最终只能得到一条路径。假如我们有概率分布矩阵：
![例图1](https://ezcodingsen.github.io/images/notebook/ctc_decoder_in_paddleocr/1.png)
可以计算每条可能路径的概率，而贪心解码只能得到一条路径，并直接得到最终的输出。这样可能陷入**局部最优**的问题。   
### 3.目标序列的概率   
而CTC解码器的关键是计算目标序列𝑌的概率，这通过将所有可能路径的概率相加实现   

$$
P(Y \mid X) = \sum_{\pi \in \text{Alignments}(Y)} P(\pi \mid X)
$$   
### 4.序列归约   
从对齐路径𝜋到最终序列𝑌，需要去掉所有 "blank" 标签以及**相邻的重复字符**。   
正如上图所描述的，通过累加和归约，我们可以的到不同目标序列（AA，AB，AAB...）的概率,再去判断哪个目标序列的概率最大，作为最终的输出。

CTC decoder在PaddleOCR中的代码实现
------







